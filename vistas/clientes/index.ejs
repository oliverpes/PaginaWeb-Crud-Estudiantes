<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRUD Estudiantes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

<div class="container mt-5">
  <h1 class="text-center mb-4">Formulario Estudiantes</h1>

  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#estudianteModal" onclick="limpiarFormulario()">
    Nuevo
  </button>

  <!-- Tabla + Footer -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped mb-0" id="tablaEstudiantes">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Carne</th>
          <th>Nombres</th>
          <th>Apellidos</th>
          <th>Dirección</th>
          <th>Teléfono</th>
          <th>Correo</th>
          <th>Tipo Sangre</th>
          <th>Fecha Nacimiento</th>
        </tr>
      </thead>
      <tbody>
        <% resultado.forEach((estudiante) => { %>
          <tr onclick="editarEstudiante(<%= JSON.stringify(estudiante) %>)">
            <td><%= estudiante.id_estudiante %></td>
            <td><%= estudiante.carne %></td>
            <td><%= estudiante.nombres %></td>
            <td><%= estudiante.apellidos %></td>
            <td><%= estudiante.direccion %></td>
            <td><%= estudiante.telefono %></td>
            <td><%= estudiante.correo_electronico %></td>
            <td><%= estudiante.sangre || '-' %></td>
            <td><%= estudiante.fecha_nacimiento %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <!-- Footer barra negra ajustado al ancho de la tabla -->
    <div class="bg-dark text-white text-center py-2">
      <small>Desarrollo web: oliver alexander perez silvestre</small>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="estudianteModal" tabindex="-1" aria-labelledby="estudianteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="estudianteModalLabel">Datos del Estudiante</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <form action="/crud_e" method="post" onsubmit="return validarFormulario()">
        <div class="modal-body">

          <!-- Campo ID (readonly grisado) -->
          <input type="text" class="form-control mb-2 bg-secondary text-white" id="txt_id" name="txt_id" value="0" readonly>

          <input type="text" class="form-control mb-2" id="txt_carne" name="txt_carne" placeholder="Carne (Ej: E001)" required>
          <input type="text" class="form-control mb-2" id="txt_nombres" name="txt_nombres" placeholder="Nombres" required>
          <input type="text" class="form-control mb-2" id="txt_apellidos" name="txt_apellidos" placeholder="Apellidos" required>
          <input type="text" class="form-control mb-2" id="txt_direccion" name="txt_direccion" placeholder="Dirección">
          <input type="text" class="form-control mb-2" id="txt_telefono" name="txt_telefono" placeholder="Teléfono">
          <input type="email" class="form-control mb-2" id="txt_correo" name="txt_correo" placeholder="Correo electrónico">

          <!-- Select dinámico para tipo sangre -->
          <select class="form-select mb-2" id="txt_tipo_sangre" name="txt_tipo_sangre" required>
            <option value="">Seleccione tipo de sangre</option>
            <% tipos.forEach((t) => { %>
              <option value="<%= t.id_tipo_sangre %>"><%= t.sangre %></option>
            <% }) %>
          </select>

          <input type="date" class="form-control mb-2" id="txt_fn" name="txt_fn" placeholder="yyyy-MM-dd">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" name="btn_crear" value="crear">Agregar</button>
          <button type="submit" class="btn btn-success" name="btn_actualizar" value="actualizar">Modificar</button>
          <button type="submit" class="btn btn-danger" name="btn_borrar" value="borrar" onclick="return confirmarEliminar()">Eliminar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </form>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Validar carnet con regex E001 - E999
  function validarFormulario() {
    const carne = document.getElementById("txt_carne").value;
    const regex = /^E\d{3}$/; // E seguido de 3 números
    if (!regex.test(carne)) {
      alert("El Carnet debe tener el formato E001 hasta E999");
      return false;
    }
    return true;
  }

  // Limpiar formulario para "Nuevo"
  function limpiarFormulario() {
    document.getElementById("txt_id").value = "0";
    document.getElementById("txt_carne").value = "";
    document.getElementById("txt_nombres").value = "";
    document.getElementById("txt_apellidos").value = "";
    document.getElementById("txt_direccion").value = "";
    document.getElementById("txt_telefono").value = "";
    document.getElementById("txt_correo").value = "";
    document.getElementById("txt_tipo_sangre").value = "";
    document.getElementById("txt_fn").value = "";
  }

  // Llenar modal al hacer clic en una fila
  function editarEstudiante(est) {
    document.getElementById("txt_id").value = est.id_estudiante;
    document.getElementById("txt_carne").value = est.carne;
    document.getElementById("txt_nombres").value = est.nombres;
    document.getElementById("txt_apellidos").value = est.apellidos;
    document.getElementById("txt_direccion").value = est.direccion;
    document.getElementById("txt_telefono").value = est.telefono;
    document.getElementById("txt_correo").value = est.correo_electronico;
    document.getElementById("txt_tipo_sangre").value = est.id_tipo_sangre;
    document.getElementById("txt_fn").value = est.fecha_nacimiento ? est.fecha_nacimiento.split("T")[0] : "";

    const modal = new bootstrap.Modal(document.getElementById("estudianteModal"));
    modal.show();
  }

  // Confirmación antes de eliminar
  function confirmarEliminar() {
    return confirm("¿Seguro que deseas eliminar este registro?");
  }
</script>
</body>
</html>
